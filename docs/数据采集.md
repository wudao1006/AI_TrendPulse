# Data Collection Technical Guide

**Version**: 1.0.0  
**Module**: Collection Core (`app/collectors`)

---

## 1. Overview (采集策略总览)

本系统实现了针对 **X (Twitter)**、**YouTube** 和 **Reddit** 三大平台的差异化采集策略。核心设计原则是：**在稳定性与数据深度之间寻找最佳平衡点**。

### 策略矩阵

| 平台 | 采集方式 | 核心技术 | 反爬难度 | 数据深度 |
| :--- | :--- | :--- | :--- | :--- |
| **X (Twitter)** | **Web Automation** | Playwright + Cookie Pool | ⭐⭐⭐⭐⭐ (极高) | 高 (含回复) |
| **YouTube** | **Official API** | Data API v3 + Transcript | ⭐ (低) | 中 (字幕+元数据) |
| **Reddit** | **Hybrid** | PRAW API + HTTP Fallback | ⭐⭐ (中) | 高 (含树状评论) |

---

## 2. X (Twitter) Deep Dive

X 平台拥有目前全网最严格的反爬策略（含动态类名混淆、流量特征指纹识别、强登录验证）。本系统采用 **"模拟人类 (Human Simulation)"** 策略进行对抗。

### 2.1 架构设计：账号池 (Account Pool)
为了突破单账号的速率限制 (Rate Limit)，系统引入了 `XAccountPool`。
*   **配置**: 通过 `X_ACCOUNTS_JSON` 注入多个账号的 `auth_token` 和 `ct0` Cookie。
*   **轮询逻辑**: 
    *   每次执行采集任务时，从池中取出一个 `active` 状态的账号。
    *   **熔断**: 若某账号连续失败 3 次（如被检测出异常），系统自动将其标记为 `paused`，并切换下一个账号。
    *   **冷却**: 账号使用后会记录 `last_used_at`，优先调度空闲时间最长的账号。

### 2.2 自动化引擎 (Playwright Automation)
使用 `Playwright (Async)` 驱动无头 Chromium 浏览器。
1.  **Context Isolation**: 每个账号运行在独立的 Browser Context 中，确保 Cookie 和 LocalStorage 互不干扰。
2.  **Stealth Mode**:
    *   **User-Agent**: 每次启动随机注入主流浏览器 UA。
    *   **Viewport**: 随机化窗口大小，防止指纹特征固定。
    *   **Jitter**: 在 `scroll`、`click` 等操作之间插入 0.7s - 1.5s 的随机停顿。

### 2.3 深度递归采集 (Recursive Collection)
传统的 API 往往只能获取主帖，本系统实现了“像人一样浏览”的深度采集：
1.  **Search Timeline**: 在搜索页抓取主推文。
2.  **Detail Expansion**: 点击进入推文详情页。
3.  **Comment Tree**: 递归抓取一级评论和二级回复 (`reply_depth` 可配置)，构建完整的对话上下文。

---

## 3. YouTube Strategy

视频平台的核心价值在于内容，但处理视频文件的成本极高。本系统采用了 **"Text-First"** 策略。

### 3.1 字幕优先 (Transcript-First)
*   **API**: 使用 `youtube-transcript-api` 获取视频的字幕轨道（优先人工字幕，其次自动生成字幕）。
*   **切片算法**:
    *   由于单个视频可能长达数小时，直接丢给 LLM 会导致 Context Window 溢出。
    *   系统实现了 **时间窗切片**：每 300 秒（5分钟）将字幕聚合并切分为一个独立的 `CollectedItem`。
    *   **元数据关联**: 每个切片保留了 `video_id` 和 `timestamp`，方便回溯原始视频位置。

### 3.2 Quota Optimization (配额优化)
*   Google Data API v3 每天只有 10,000 点配额。
*   **优化**: 仅使用 API 进行 `Search` (消耗 100点) 和 `Video Details` (消耗 1点) 操作。字幕获取完全走非官方接口，不消耗配额。这使得单日采集上限提升了 100 倍。

---

## 4. Reddit Hybrid Engine

Reddit 的 API 政策收紧导致纯 API 采集变得昂贵且受限。系统实现了双模引擎。

### 4.1 模式一：PRAW (Official API)
*   **触发条件**: 当配置了 `REDDIT_CLIENT_ID` 时优先启用。
*   **优势**: 结构化好，能获取完整的评论树 (`comment_forest`)。
*   **限制**: QPS 限制严格。

### 4.2 模式二：HTTP Fallback (无凭证模式)
*   **触发条件**: 未配置 API Key 或 API 报错时自动降级。
*   **原理**: 伪造 `User-Agent` 直接访问 `https://www.reddit.com/r/{subreddit}/search.json` 公开接口。
*   **优势**: 无需鉴权，适合快速采集热门 (Hot) 列表。
*   **鲁棒性**: 内置重试机制，应对 `429 Too Many Requests`。

---

## 5. Anti-Scraping Summary (反爬对抗总结)

| 挑战 | 解决方案 | 实施位置 |
| :--- | :--- | :--- |
| **IP 封禁** | 支持配置 HTTP 代理 (`X_PROXY`) | `app.config.Settings` |
| **指纹识别** | 随机 UA + 随机视窗 + 无头模式开关 | `app.collectors.x` |
| **行为检测** | 操作随机延时 (Random Jitter) | `app.collectors.x` |
| **账号风控** | 账号池轮询 + 自动熔断 | `app.collectors.x` |

---
*End of Guide*
